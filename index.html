<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Juego de Gatitos Responsive</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ff7ab6">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#f0f2f5;
      --panel:#ffffff;
      --accent:#ff7ab6;
      --accent2:#7ac7ff;
      --muted:#7b6f8a;
      --star-inactive: #dbe0e6;
      --star-active: #ffc93f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background-color: var(--bg);
      overflow: hidden;
    }
    body { display: flex; flex-direction: column; }
    .container {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      padding: 8px;
      gap: 8px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      overflow: hidden;
    }
    header {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
      padding: 0 8px;
    }
    h1 { font-size: 20px; }
    .panel {
      background: var(--panel);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(50, 30, 100, 0.05);
    }
    #stars-container { display: flex; gap: 4px; }
    .star {
      font-size: 24px;
      color: var(--star-inactive);
      transition: color 0.3s ease, transform 0.3s ease;
    }
    .star.earned {
      color: var(--star-active);
      transform: scale(1.1);
    }
    .star.animate { animation: star-pop 0.6s ease-out; }
    @keyframes star-pop {
      0% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1.5); opacity: 1; }
      100% { transform: scale(1.1); opacity: 1; }
    }
    .game-layout {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-grow: 1;
      min-height: 0;
    }
    .top-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-shrink: 0;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px;
      padding: 8px;
    }
    .stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px;
      border-radius: 8px;
      background: #f7f9fc;
      font-weight: 600;
    }
    .stat span:first-child { font-size: 11px; color: var(--muted); }
    .stat span:last-child { font-size: 18px; }
    .board-container { flex-grow: 1; min-height: 250px; }
    .board {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #87CEEB 0%, #E0F8FF 50%, #FAEBD7 100%);
    }
    #playfield { position: relative; width: 100%; height: 100%; }
    .kitten {
      position: absolute;
      font-size: 48px;
      cursor: pointer;
      transform: translate(-50%, -50%);
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: manipulation;
    }
    .controls { display: flex; gap: 12px; }
    button {
      flex-grow: 1;
      cursor: pointer;
      border: 0;
      padding: 12px;
      border-radius: 10px;
      background: linear-gradient(180deg, var(--accent), #ff5fa1);
      color: white;
      font-weight: 700;
      font-size: 16px;
    }
    button.alt { background: linear-gradient(180deg, var(--accent2), #3baeff); }
    button.ghost { background: transparent; color: var(--muted); border: 1px solid #eee; }
    .center-note {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 90%;
      background: rgba(255, 255, 255, 0.7);
      padding: 16px;
      border-radius: 12px;
    }
    .small {font-size: 13px; color: var(--muted);}
    @media (min-width: 768px) {
      .container { padding: 24px; gap: 12px; }
      .game-layout { flex-direction: row; }
      .top-row { flex-direction: column; width: 300px; flex-shrink: 0; }
      .stats { grid-template-columns: 1fr 1fr; padding: 12px; }
      .stat { flex-direction: row; justify-content: space-between; padding: 10px; }
      .stat span:first-child { font-size: inherit; color: inherit; }
      .stat span:last-child { font-size: inherit; }
    }
  </style>
</head>
<body>
  
  <div class="container">
    <header>
      <h1>üêæ Juego de Gatitos</h1>
      <div style="flex:1"></div>
      <div id="stars-container"></div>
    </header>

    <div class="game-layout">
      <div class="top-row">
        <div class="stats panel">
          <div class="stat"><span>Puntuaci√≥n</span><span id="score">0</span></div>
          <div class="stat"><span>Mejor</span><span id="best">0</span></div>
          <div class="stat"><span>Tiempo</span><span id="time">60</span></div>
          <div class="stat"><span>Nivel</span><span id="level">1</span></div>
          <div class="stat"><span>Vidas</span><span id="lives">5</span></div>
        </div>
        <div class="panel">
          <div class="controls">
            <button id="start">Iniciar</button>
            <button id="pause" class="ghost">Pausa</button>
            <button id="mute" class="alt">üîä</button>
          </div>
        </div>
      </div>
      <main class="board-container panel">
        <div class="board">
            <div id="playfield"></div>
            <div class="center-note" id="message">
              <div style="font-size:28px;font-weight:800">üê± ¬°Bienvenido!</div>
              <div class="small">Pulsa Iniciar para jugar.</div>
            </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    const playfield = document.getElementById('playfield');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const timeEl = document.getElementById('time');
    const levelEl = document.getElementById('level');
    const livesEl = document.getElementById('lives');
    const message = document.getElementById('message');
    const startBtn = document.getElementById('start');
    const pauseBtn = document.getElementById('pause');
    const muteBtn = document.getElementById('mute');
    const starsContainer = document.getElementById('stars-container');

    let width = 0, height = 0;
    let kittens = [];
    let score = 0;
    let best = Number(localStorage.getItem('gatos_best') || 0);
    bestEl.textContent = best;
    let timeLeft = 60;
    let level = 1;
    let lives = 5;
    let running = false;
    let paused = false;
    let spawnInterval = 1200;
    let spawnTimer = null;
    let gameLoopInterval = null;
    let gameTimer = null;
    let moveSpeed = 1;
    let muted = false;
    let shieldUntil = 0;
    let slowMoUntil = 0;
    let audioCtx;

    function playSfx(type = 'click') {
      if (muted) return;
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g);
        g.connect(audioCtx.destination);
        g.gain.value = 0.08;
        switch (type) {
          case 'powerup': o.type = 'triangle'; o.frequency.setValueAtTime(1000, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5); break;
          case 'bad': o.type = 'square'; o.frequency.setValueAtTime(200, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3); break;
          case 'miss': o.type = 'sawtooth'; o.frequency.setValueAtTime(300, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.2); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2); break;
          case 'levelUp': o.type = 'sine'; o.frequency.setValueAtTime(523, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime); setTimeout(() => { o.frequency.setValueAtTime(659, audioCtx.currentTime); }, 80); setTimeout(() => { o.frequency.setValueAtTime(783, audioCtx.currentTime); }, 160); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.4); break;
          case 'gameOver': o.type = 'triangle'; o.frequency.setValueAtTime(440, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 1); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 1); break;
          case 'starGet': o.type = 'sine'; o.frequency.setValueAtTime(880, audioCtx.currentTime); g.gain.setValueAtTime(0.12, audioCtx.currentTime); setTimeout(() => { o.frequency.setValueAtTime(1046, audioCtx.currentTime); }, 100); setTimeout(() => { o.frequency.setValueAtTime(1318, audioCtx.currentTime); }, 200); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5); break;
          case 'clear': o.type = 'sawtooth'; o.frequency.setValueAtTime(1200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.3); g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.4); break;
          case 'click': default: o.type = 'sine'; o.frequency.value = 800; g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1); break;
        }
        o.start();
        o.stop(audioCtx.currentTime + 1);
      } catch (e) { console.warn('Audio not available', e); }
    }

    function initStars() {
      starsContainer.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const starEl = document.createElement('div');
        starEl.className = 'star';
        starEl.textContent = '‚òÖ';
        starsContainer.appendChild(starEl);
      }
    }

    function updateStars() {
        const starsEarned = Math.min(5, Math.floor(level / 3));
        const starElements = starsContainer.children;
        for (let i = 0; i < starElements.length; i++) {
            if (i < starsEarned) {
                if (!starElements[i].classList.contains('earned')) {
                    starElements[i].classList.add('earned', 'animate');
                    playSfx('starGet');
                    starElements[i].addEventListener('animationend', () => {
                        starElements[i].classList.remove('animate');
                    }, { once: true });
                }
            } else {
                starElements[i].classList.remove('earned', 'animate');
            }
        }
    }

    function resize(){ const r = playfield.getBoundingClientRect(); width = r.width; height = r.height; }
    window.addEventListener('resize', resize);
    function rand(min,max){return Math.random()*(max-min)+min}
    
    function spawnKitten(type, options = {}){
      const el = document.createElement('div'); el.className='kitten'; el.dataset.type = type; let emoji='üê±'; let value=10;
      switch(type){ 
        case 'golden': emoji='üòª'; value=30; break; 
        case 'fast': emoji='üêØ'; value=15; break; 
        case 'shield': emoji='üõ°Ô∏è'; value=0; break; 
        case 'nasty': emoji='üëª'; value=-1; break; 
        case 'time': emoji='‚è∞'; value=5; break; 
        case 'life': emoji='üíñ'; value=0; break; 
        case 'slowmo': emoji='üê¢'; value=5; break; 
        case 'superLife': emoji='‚ù§Ô∏è‚Äçüî•'; value=0; break;
        case 'skull': emoji='üíÄ'; value=-1; break;
        case 'dog': emoji='üê∂'; value=0; break;
      }
      el.innerText = emoji; 
      if(width <= 0 || height <= 0) resize(); 
      const x = options.x !== undefined ? options.x : rand(40, Math.max(50, width-40)); 
      const y = options.y !== undefined ? options.y : rand(40, Math.max(50, height-40)); 
      el.style.left = x+'px'; 
      el.style.top = y+'px';
      
      if (type === 'superLife') { el.style.fontSize = '30px'; } 
      else if (type === 'dog') { el.style.fontSize = '28px'; } 
      else { el.style.fontSize = (38 + Math.random()*20) + 'px'; }
      
      playfield.appendChild(el);

      const isFast = type === 'fast' || type === 'superLife';
      const kitty = { el, x, y, vx: type === 'dog' ? 0 : rand(-1,1) * moveSpeed * (isFast ? 2 : 1), vy: type === 'dog' ? 0 : rand(-1,1) * moveSpeed * (isFast ? 2 : 1), type, value }; 
      kittens.push(kitty);
      el.addEventListener('pointerdown', (ev)=>{ ev.stopPropagation(); handleClickKitten(kitty); });
      
      const lifeTime = type === 'dog' ? 2500 : Math.floor(rand(1800,4000)); 
      setTimeout(()=>{ if(!playfield.contains(el)) return; removeKitten(kitty, false); }, lifeTime); 
      spawnSparkle(x,y);
    }
    
    function removeKitten(kitty, clicked){
      if(!kitty) return; try{ kitty.el.remove(); }catch(e){} const idx = kittens.indexOf(kitty); if(idx>=0) kittens.splice(idx,1);
      if(!clicked){ if(['nasty','time','life','slowmo','superLife','skull','dog'].includes(kitty.type)) return; if(Date.now() < shieldUntil) return; lives = Math.max(0,lives-1); livesEl.textContent = lives; if(running) playSfx('miss'); if(lives<=0) endGame(); }
    }
    
    // --- 1. MODIFICADO: L√ìGICA DE PUNTUACI√ìN DEL PERRO ---
    function handleClickKitten(kitty){
      if(!kitty) return; let soundType = 'click';
      if(kitty.type==='golden'){ score += kitty.value * 3; showFloating('+'+(kitty.value*3), kitty.x, kitty.y); soundType = 'powerup';
      } else if(kitty.type==='shield'){ shieldUntil = Date.now() + 5000; showFloating('üõ°Ô∏è Escudo', kitty.x, kitty.y); soundType = 'powerup';
      } else if(kitty.type==='fast'){ score += kitty.value; spawnInterval = Math.max(300, spawnInterval - 80); restartSpawnLoop(); showFloating('+'+kitty.value, kitty.x, kitty.y); soundType = 'powerup';
      } else if(kitty.type==='nasty'){ score = Math.max(0, score - 15); showFloating('-15', kitty.x, kitty.y); soundType = 'bad';
      } else if(kitty.type === 'time') { timeLeft += kitty.value; timeEl.textContent = timeLeft; showFloating(`+${kitty.value}s`, kitty.x, kitty.y); soundType = 'powerup';
      } else if(kitty.type === 'life') { lives++; livesEl.textContent = lives; showFloating('+1 Vida', kitty.x, kitty.y); soundType = 'powerup';
      } else if(kitty.type === 'slowmo') { slowMoUntil = Date.now() + 5000; showFloating('üê¢ Lento', kitty.x, kitty.y); soundType = 'powerup';
      } else if(kitty.type === 'superLife') { lives += 3; livesEl.textContent = lives; showFloating('+3 Vidas', kitty.x, kitty.y); soundType = 'powerup';
      } else if(kitty.type === 'skull') {
          lives = Math.max(0, lives - 1); livesEl.textContent = lives; showFloating('-1 Vida', kitty.x, kitty.y); soundType = 'bad';
          if (lives <= 0) endGame();
      } else if(kitty.type === 'dog') {
          soundType = 'clear';
          let pointsGained = 0;
          
          // Itera sobre una copia del array para limpiar la pantalla y sumar puntos
          for (const k of [...kittens]) {
              if (k !== kitty) { // No procesar el perro mismo
                  // Suma los puntos correspondientes de cada gato eliminado
                  switch(k.type) {
                      case 'golden':
                          pointsGained += k.value * 3;
                          break;
                      case 'fast':
                      case 'slowmo': // El item de slowmo tambi√©n da puntos
                      case 'normal':
                          pointsGained += k.value;
                          break;
                  }
                  removeKitten(k, true);
              }
          }
          
          if (pointsGained > 0) {
            score += pointsGained;
            showFloating(`+${pointsGained} ¬°GUAU!`, kitty.x, kitty.y);
          } else {
            showFloating('¬°GUAU!', kitty.x, kitty.y);
          }
      } else { score += kitty.value; showFloating('+'+kitty.value, kitty.x, kitty.y); }
      
      playSfx(soundType); 
      scoreEl.textContent = score; 
      removeKitten(kitty, true); 
      if(score >= level*100){ levelUp(); }
    }
    
    function showFloating(text,x,y){ const f = document.createElement('div'); f.style.position='absolute'; f.style.left=x+'px'; f.style.top=y+'px'; f.style.transform='translate(-50%,-50%)'; f.style.fontWeight=800; f.style.pointerEvents='none'; f.style.fontSize='18px'; f.textContent=text; playfield.appendChild(f); let t=0; const id = setInterval(()=>{ t+=16; f.style.top = (y - (t/12)) + 'px'; f.style.opacity = 1 - t/600; if(t>600){ clearInterval(id); f.remove(); } },16); }
    function spawnSparkle(x,y){ for(let i=0;i<6;i++){ const s = document.createElement('div'); s.style.position='absolute'; s.style.width='8px'; s.style.height='8px'; s.style.borderRadius='50%'; s.style.left=x+'px'; s.style.top=y+'px'; s.style.background=['#ffd6e8','#fff2b2','#cfefff'][Math.floor(Math.random()*3)]; playfield.appendChild(s); const ang = Math.random()*Math.PI*2; const dist = 20+Math.random()*60; const dx = Math.cos(ang)*dist; const dy = Math.sin(ang)*dist; s.animate([{transform:'translate(-50%,-50%)'},{transform:`translate(${dx}px,${dy}px)`,opacity:0}],{duration:700+Math.random()*300,easing:'ease-out'}).onfinish = ()=> s.remove(); } }
    
    function gameStep(){ 
      for(const k of kittens){
        let currentSpeedMultiplier;
        if (k.type === 'superLife') { currentSpeedMultiplier = 1.5; } 
        else { currentSpeedMultiplier = (Date.now() < slowMoUntil) ? 0.4 : 1.5; }
        k.x += k.vx * currentSpeedMultiplier; k.y += k.vy * currentSpeedMultiplier; 
        if(k.x < 10 || k.x > width-10) k.vx *= -1; 
        if(k.y < 10 || k.y > height-10) k.vy *= -1; 
        k.el.style.left = Math.max(8,Math.min(width-8,k.x)) + 'px'; 
        k.el.style.top = Math.max(8,Math.min(height-8,k.y)) + 'px'; 
      } 
    }
    
    function levelUp(){ 
      level++; levelEl.textContent = level; moveSpeed += 0.25; spawnInterval = Math.max(350, spawnInterval - 80); 
      playSfx('levelUp'); updateStars(); restartSpawnLoop(); 
      message.innerHTML = `<div style="font-size:28px;font-weight:900">Nivel ${level}</div>`; 
      message.style.display = 'block'; 
      setTimeout(()=>{ message.style.display = 'none'; },1200); 
    }
    
    function scheduleSpawn(){ 
      spawnTimer = setTimeout(()=>{ 
        if(!running || paused) return; 
        const r = Math.random(); 
        if(r < 0.05) spawnKitten('golden'); 
        else if(r < 0.10) spawnKitten('fast'); 
        else if(r < 0.14) spawnKitten('shield'); 
        else if(r < 0.19) spawnKitten('nasty'); 
        else if(r < 0.23) spawnKitten('time'); 
        else if(r < 0.27) spawnKitten('life'); 
        else if(r < 0.31) spawnKitten('slowmo');
        else if(r < 0.34) spawnKitten('superLife'); 
        else if(r < 0.38) { 
            const normalKittens = kittens.filter(k => k.type === 'normal');
            if (normalKittens.length > 0) {
              const targetKitten = normalKittens[Math.floor(Math.random() * normalKittens.length)];
              const offsetX = rand(-80, 80); const offsetY = rand(-80, 80);
              const spawnX = Math.max(30, Math.min(width - 30, targetKitten.x + offsetX));
              const spawnY = Math.max(30, Math.min(height - 30, targetKitten.y + offsetY));
              spawnKitten('skull', { x: spawnX, y: spawnY });
            } else { spawnKitten('normal'); }
        }
        else spawnKitten('normal'); 
        if(running && !paused) scheduleSpawn(); 
      }, spawnInterval); 
    }
    
    function restartSpawnLoop(){ if(spawnTimer) clearTimeout(spawnTimer); if(running && !paused) scheduleSpawn(); }
    
    function startGame(){ 
      if(running) return; 
      resize(); 
      running = true; paused=false; score = 0; scoreEl.textContent = score; timeLeft = 60; timeEl.textContent = timeLeft; level = 1; levelEl.textContent = level; lives = 5; livesEl.textContent = lives; spawnInterval = 1200; moveSpeed = 1; shieldUntil = 0; slowMoUntil = 0; 
      message.style.display = 'none';
      initStars();
      for(const k of [...kittens]) removeKitten(k,true); restartSpawnLoop(); 
      if(gameLoopInterval) clearInterval(gameLoopInterval); gameLoopInterval = setInterval(()=>{ if(!paused) gameStep(); }, 16); 
      if(gameTimer) clearInterval(gameTimer); gameTimer = setInterval(()=>{ if(!running) { clearInterval(gameTimer); return; } if(paused) return; timeLeft--; timeEl.textContent = timeLeft; if(timeLeft <= 0){ clearInterval(gameTimer); endGame(); } },1000); 
    }
    
    function endGame(){ 
      running=false; paused=false; if (lives > 0) playSfx('gameOver'); 
      if(spawnTimer) clearTimeout(spawnTimer); spawnTimer = null; if(gameLoopInterval) clearInterval(gameLoopInterval); gameLoopInterval = null; if(gameTimer) clearInterval(gameTimer); gameTimer = null; 
      for(const k of [...kittens]) removeKitten(k,true); 
      if(score > best){ best = score; localStorage.setItem('gatos_best', String(best)); bestEl.textContent = best; } 
      message.innerHTML = `<div style="font-size:28px;font-weight:900">Fin del juego</div><div class="small">Puntuaci√≥n: <strong>${score}</strong></div><div style="margin-top:8px"><button id="replay">Jugar otra vez</button></div>`;
      message.style.display = 'block';
      document.getElementById('replay')?.addEventListener('click', startGame);
    }

    pauseBtn.addEventListener('click', ()=>{ if(!running) return; paused = !paused; pauseBtn.textContent = paused? 'Reanudar' : 'Pausa'; if(paused){ if(spawnTimer) clearTimeout(spawnTimer); } else { restartSpawnLoop(); } });
    muteBtn.addEventListener('click', ()=>{ muted = !muted; muteBtn.textContent = muted? 'üîá' : 'üîä'; if(!muted && !audioCtx){ playSfx('click');} });
    startBtn.addEventListener('click', startGame);
    playfield.addEventListener('pointerdown', (ev)=>{ if(!running || paused) return; if(ev.target !== playfield) return; if(Date.now() < shieldUntil) return; lives = Math.max(0,lives-1); livesEl.textContent = lives; playSfx('miss'); if(lives<=0) endGame(); });
    
    // --- 2. CORREGIDO Y MEJORADO: L√ìGICA DE APARICI√ìN DEL PERRO ---
    setInterval(()=>{ 
        if(!running || paused) return; 
        const catCount = kittens.length;
        // Si la pantalla tiene pocos gatos, a√±ade uno normal para mantener la acci√≥n
        if(catCount < Math.min(8, 3 + level)){ 
            if(Math.random() < 0.35) spawnKitten('normal'); 
        } 
        // Si la pantalla est√° muy llena, hay una peque√±a probabilidad de que aparezca el perro
        else if (catCount > 4 && Math.random() < 1.0) { // Umbral de 10 gatos y 8% de probabilidad
            spawnKitten('dog');
        }
    }, 800);

    window.addEventListener('beforeunload', ()=>{ localStorage.setItem('gatos_best', String(best)); });
    message.addEventListener('click', (ev)=>{ if(ev.target.id === 'replay') return; if(!running) startGame(); });
    
    initStars();
    resize();
  </script>

</body>
</html>